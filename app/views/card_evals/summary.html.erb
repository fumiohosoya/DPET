<%= render 'admin/backtoadmin' %>
<div class="row mb-3">
    <% @companies.each do |e| %>
        <% btc = @target_c.id == e.id ? "btn-warning" : "btn-danger" %>
        
        <div class="col-2 mb-1">
            <%= link_to ((c = array_find_by(@companies, e.id)) ? c.name_e.truncate(22) : ""),
                summary_card_evals_path(company: e.id),
                class: "btn #{btc} btn-block" %>
        </div>
    <% end %>
</div>
<h2><%=  find_company(@company_id).name_e %></h2> 

<div class="bgwhite row mt-4">
    
    <% if @drivers.any? %>

        <% @branches.each do |branch| %>
        <div class="btn btn-danger w-100 mb-2"><%= find_branch(@company_id, branch.to_i).name %></div>
            <div class="offset-1 col-10">
                <table class="table table-striped table-bordered">
                    <tr>
                       <th >name</th> 
                       <th>Safety</th> 
                       <th>SafetyRank</th> 
                       <th>Check</th> 
                       <th>CheckRank</th> 
                       <th>Fuel</th> 
                       <th>FuelRank</th> 
                       <th>Total</th> 
                       <th>TotalRank</th> 
                       <th>Link</th> 
                    </tr>
                    <% @drivers.each do |driver| %>
                        <tr>
                            <td class="text-left"> <%= driver.name %></td>
                            <td class="text-left ml-4"> <%= (v = driver.get_year_eval(@year)[1])? v : "NONE" %></td>
                            <td class="text-center"> <%= v ? driver.conv_dvalue_to_ranking(v) : "NONE" %></td>
                            <td class="text-left ml-4">
                               <%= v ? (checkp = driver.get_yearly_checkitempoint(@year)) : "NONE" %>
                            </td>
                            <td class="text-center">
                               <%= v ? driver.conv_dvalue_to_ranking(checkp) : "NONE" %>
                            </td>
                            <td class="text-left ml-4">
                                <% if !v %>
                                   NONE
                                <% elsif @displayflag.driverfuel? %>
                                    <%=  (mlg = driver.get_yearly_fuelcomsamption(@year))? mlg : "NONE" %>
                                <% else %>
                                   Not Display
                                <% end %>
                            </td>
                            <td class="text-center">
                                <% if !v %>
                                   NONE
                                <% elsif @displayflag.driverfuel? %>
                                   <%= (fe = driver.conv_fuel_to_ranking(mlg, driver.get_fuel_target)) ? fe : "NONE" %>
                                <% else %>
                                   Not Display
                                <% end %>
                            </td>
                            
                   <% if @displayflag.driverfuel? %>
                    <% 
                        evalparam = Evalparam.find_by(company_id: driver.company)
                        if (evalparam)
                            balanceSafety = evalparam.balanceSafety / 100.0
                            balanceCheck = evalparam.balanceCheck / 100.0
                            balanceFuel = evalparam.balanceFuel / 100.0
                        else
                            balanceSafety = (33.30 / 100.0)
                            balanceCheck = (33.40 / 100.0)
                            balanceFuel = (33.30 / 100.0)
                        end
                        
                        fuelrank = driver.conv_fuel_to_ranking(mlg, driver.get_fuel_target)
                        
                        fuelpoint_hash = {A: 100, B: 80, C: 60, E: 40, F:20, G: 0}
                        fuelpoint = fuelpoint_hash[fuelrank.to_sym]
                    
                        v = 0 if v == nil
                        checkp = 0 if checkp == nil
                        totalval = v * balanceSafety + 
                                    checkp * balanceCheck + fuelpoint * balanceFuel 
                                    
                        totalrank = driver.conv_dvalue_to_ranking(totalval)
                                    
                      %>                   
                    <% else %>
                        <% 
                            evp = Evalparam.find(driver.company)
                            if (evalparam)
                                balanceSafety = evp.balanceSafety / (evp.balanceSafety + evp.balanceCheck)
                                balanceCheck =  evp.balanceCheck /  (evp.balanceSafety + evp.balanceCheck)
                            else
                                balanceSafety = 0.5
                                balanceCheck = 0.5
                            end
                            v = 0 if v == nil
                            checkp = 0 if checkp == nil
                            totalval = v.evaluate * balanceSafety +  checkp * balanceCheck
                            totalrank = driver.conv_dvalue_to_ranking(totalval)
                        %>
                    <% end %>
                            <td class="text-left ml-4">
                                <% if v == 0 %>
                                   NONE
                                <% else %>
                                    <%= totalval.ceil(2) %>
                                <% end %>
                            </td>
                            <td class="text-center">
                                <% if v == 0 %>
                                   NONE
                                <% else %>
                                    <%= totalrank %>
                                <% end %>
                            </td>
                            <td class="text-center">
                                <% if v != 0 %>
                                    <%= link_to "more",  summary_driver_path(driver.id),
                                        class:"btn btn-xs btn-success" %>
                                <% end %>
                            </td
                        </tr>
                    
                
                    <% end %>
                </table>
 
            </div>
        </div>
        <% end %>
    <% end %>
</div>
                    
